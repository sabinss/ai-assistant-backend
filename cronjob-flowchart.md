┌─────────────────────────────────────────────────────────────────────────────┐
│                         CRON JOB STARTS                                     │
│                    Every 3 hours in UTC                                     │
│              (00:00, 03:00, 06:00, 09:00, 12:00, 15:00, 18:00, 21:00)       │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STEP 1: Calculate UTC Window                                               │
│  ─────────────────────────────                                              │
│  utcNow = current UTC time                                                  │
│  utcWindowStart = utcNow - 3 hours                                          │
│  utcWindowEnd = utcNow                                                      │
│                                                                             │
│  Example: If cron runs at 15:00 UTC                                         │
│           Window = 12:00 - 15:00 UTC                                        │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STEP 2: Log Cron Start                                                     │
│  ─────────────────────────                                                  │
│  Save to AgentCronLog: status = "cron_started"                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STEP 3: Get All Organizations                                              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                    ┌───────────────────────────────┐
                    │  FOR EACH ORGANIZATION        │
                    └───────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STEP 4: Find Active Scheduled Agents                                       │
│  ─────────────────────────────────────                                      │
│  Query:                                                                     │
│    - active = true                                                          │
│    - isAgent = true                                                         │
│    - frequency IN ['Daily', 'Weekly', 'Monthly']                            │
│    - Daily: needs scheduleTime                                              │
│    - Weekly/Monthly: needs dayTime                                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                         ┌──────────────────┐
                         │ Agents found?    │
                         └──────────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    │ NO                            │ YES
                    ▼                               ▼
            ┌──────────────┐          ┌─────────────────────────────┐
            │ Skip to next │          │  FOR EACH AGENT             │
            │ organization │          └─────────────────────────────┘
            └──────────────┘                        │
                                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STEP 5: Convert Timezone                                                   │
│  ────────────────────────                                                   │
│                                                                             │
│  Agent timezone: "EST" → getIANATimezone() → "America/New_York"             │
│                                                                             │
│  Mapping:                                                                   │
│  ┌─────────┬─────────────────────┐                                         │
│  │ EST     │ America/New_York    │                                         │
│  │ PST     │ America/Los_Angeles │                                         │
│  │ IST     │ Asia/Kolkata        │                                         │
│  │ JST     │ Asia/Tokyo          │                                         │
│  │ ...     │ ...                 │                                         │
│  └─────────┴─────────────────────┘                                         │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STEP 6: Convert Agent's Local Time to UTC                                  │
│  ─────────────────────────────────────────                                  │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ DAILY                                                                │   │
│  │ scheduleTime: "10:00" (local) → convertLocalTimeToUTC()              │   │
│  │ Example: 10:00 AM EST → 15:00 UTC                                    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ WEEKLY                                                               │   │
│  │ dayTime: "1" (Monday) + scheduleTime: "09:00"                        │   │
│  │ Convert: Monday 9:00 AM EST → Monday 14:00 UTC                       │   │
│  │ (or Tuesday if timezone shift crosses midnight)                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ MONTHLY                                                              │   │
│  │ dayTime: "15" (15th) + scheduleTime: "14:00"                         │   │
│  │ Convert: 15th 2:00 PM IST → 15th 08:30 UTC                           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STEP 7: Check if Already Triggered                                         │
│  ──────────────────────────────────                                         │
│                                                                             │
│  Check lastTriggeredAt:                                                     │
│    - Daily: Already ran TODAY? → Skip                                       │
│    - Weekly: Already ran THIS WEEK? → Skip                                  │
│    - Monthly: Already ran THIS MONTH? → Skip                                │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                         ┌──────────┴──────────┐
                         │ Already triggered?  │
                         └─────────────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    │ YES                           │ NO
                    ▼                               ▼
            ┌──────────────────┐        ┌──────────────────────────┐
            │ Log: "skipped"   │        │ Continue to Step 8       │
            │ Reason: Already  │        └──────────────────────────┘
            │ triggered        │                    │
            └──────────────────┘                    │
                                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  STEP 8: Check if UTC Hour in Window                                        │
│  ───────────────────────────────────                                        │
│                                                                             │
│  isHourInWindow(targetUTCHour, windowStart, windowEnd)                      │
│                                                                             │
│  Window: 12:00 - 15:00 UTC                                                  │
│  Check: targetHour > 12 AND targetHour <= 15                                │
│                                                                             │
│  Example:                                                                   │
│    Target UTC hour = 15 → 15 > 12 ✓ AND 15 <= 15 ✓ → IN WINDOW             │
│    Target UTC hour = 11 → 11 > 12 ✗ → NOT IN WINDOW                        │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                         ┌──────────┴──────────┐
                         │  Hour in window?    │
                         └─────────────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    │ NO                            │ YES
                    ▼                               ▼
┌──────────────────────────────┐    ┌─────────────────────────────────────────┐
│  Log: "skipped"              │    │  STEP 9: TRIGGER AGENT                  │
│  Reason: Hour X not in       │    │  ─────────────────────                  │
│  window Y-Z UTC              │    │                                         │
└──────────────────────────────┘    │  1. Generate session_id                 │
                                    │                                         │
                                    │  2. Build API URL:                      │
                                    │     /ask/agent?agent_name=X             │
                                    │               &org_id=Y                 │
                                    │               &query='run'              │
                                    │               &session_id=Z             │
                                    │                                         │
                                    │  3. Log: status = "triggered"           │
                                    │                                         │
                                    │  4. Call Python API (axios.get)         │
                                    │                                         │
                                    │  5. Update lastTriggeredAt = now()      │
                                    │                                         │
                                    │  6. Log: status = "success"             │
                                    └─────────────────────────────────────────┘
                                                   │
                                                   ▼
                                    ┌─────────────────────────────┐
                                    │  Next Agent                 │
                                    └─────────────────────────────┘
                                                   │
                                                   ▼
                                    ┌─────────────────────────────┐
                                    │  All agents processed?      │
                                    └─────────────────────────────┘
                                                   │
                                    ┌──────────────┴──────────────┐
                                    │ NO                          │ YES
                                    ▼                             ▼
                            ┌──────────────┐      ┌───────────────────────────┐
                            │ Next Agent   │      │ Next Organization         │
                            └──────────────┘      └───────────────────────────┘
                                                              │
                                                              ▼
                                              ┌───────────────────────────────┐
                                              │ All organizations processed?  │
                                              └───────────────────────────────┘
                                                              │
                                              ┌───────────────┴───────────────┐
                                              │ NO                            │ YES
                                              ▼                               ▼
                                      ┌──────────────┐    ┌───────────────────────┐
                                      │ Next Org     │    │  STEP 10: Log Summary │
                                      └──────────────┘    │  ─────────────────────│
                                                          │                       │
                                                          │  status: cron_completed
                                                          │  totalAgentsChecked   │
                                                          │  totalAgentsTriggered │
                                                          │  totalAgentsSkipped   │
                                                          └───────────────────────┘
                                                                      │
                                                                      ▼
                                                          ┌───────────────────────┐
                                                          │    CRON JOB ENDS      │
                                                          └───────────────────────┘